<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
<title>
Insecure Temporary File Creation During Build: Arbitrary Code Execution
</title>
<link rel="stylesheet" type="text/css" href="vulnerablevim.css">
<script type="text/javascript" src="vulnerablevim.js"></script>
</head>
<body>
<!-- BEGIN site header -->
<div class="header">
<a href="vulnerablevim-index.html">
Vulnerable Vim
</a>
</div>
<!-- END site header -->
<pre>
<span class="vulntitle"
>Insecure Temporary File Creation During Build: Arbitrary Code Execution</span>

1. SUMMARY

Product  : Vim -- Vi IMproved
Versions : &gt;=5.0 (possibly older; 4.6 and 3.0 not vulnerable), &lt;7.2b.014
Impact   : Arbitrary code execution
Wherefrom: Local
Original : http://www.rdancer.org/vulnerablevim-configure.in.html
           http://www.rdancer.org/vulnerablevim-configure.in.patch

Insecure temporary file creation during the build process is vulnerable
to symbolic link attacks, and arbitrary code execution.  Patch provided.
Update: There is no race condition.  All files can be prepared
beforehand, facilitating a reliable attack.


2. BACKGROUND

  ``Vim is an almost compatible version of the UNIX editor Vi. Many new
    features have been added: multi-level undo, syntax highlighting,
    command line history, on-line help, spell checking, filename
    completion, block operations, etc.''

    		-- Vim README.txt 


3. VULNERABILITY

During the build process, a temporary file with a predictable name is
created in the ``/tmp'' directory.  This code is run when Vim is being
build with Python support:

src/configure.in:

    677         dnl -- we need to examine Python's config/Makefile too
    678         dnl    see what the interpreter is built from
    679         AC_CACHE_VAL(vi_cv_path_python_plibs,
    680         [
    681             tmp_mkf=&quot;/tmp/Makefile-conf$$&quot;
(1) 682             cat ${PYTHON_CONFDIR}/Makefile - &lt;&lt;'eof' &gt;${tmp_mkf}
    683 __:
    684         @echo &quot;python_MODLIBS='$(MODLIBS)'&quot;
    685         @echo &quot;python_LIBS='$(LIBS)'&quot;
    686         @echo &quot;python_SYSLIBS='$(SYSLIBS)'&quot;
    687         @echo &quot;python_LINKFORSHARED='$(LINKFORSHARED)'&quot;
    688 eof
    689             dnl -- delete the lines from make about Entering/Leaving directory
(2) 690             eval &quot;`cd ${PYTHON_CONFDIR} &amp;&amp; make -f ${tmp_mkf} __ | sed '/ directory /d'`&quot;
    691             rm -f ${tmp_mkf}

The attacker has to create the temporary file
``/tmp/Makefile-conf&lt;PID&gt;'' before it is first written to at (1).  In
the time between (1) and (2), arbitrary commands can be written to the
file.  They will be executed at (2).  Update: if the file is not
writable, the truncation at (1) will not happen[2].  The attacker may
create files for all the possible PID values in advance:
	
	time perl -e 'foreach (1..32768){ symlink &quot;/path/to/exploit&quot;,
	    &quot;/tmp/Makefile-conf$_&quot; }'

	real    0m30.963s
	user    0m0.072s
	sys     0m29.694s


3. TEST CASE

No test case.


4. PATCH

Patch fixing this vulnerability can be found at the following URL:

    http://www.rdancer.org/vulnerablevim-configure.in.patch

Please note: The patch fixes ``src/configure.in'', an input file used by
the ``autoconf'' command.  ``autoconf'' uses this input file to create
``src/auto/configure''.  It is necessary to remove the latter, if
present, to force its recreation.  Otherwise, further build runs will
still use it, and the vulnerability will still be present.

Patch 7.2b.014[1] fixes this vulnerability.


5. REFERENCES

[1] Patch 7.2b.014
    Message-Id: &lt;200807241424.m6OEOXd4017351@moolenaar.net&gt;
    http://groups.google.com/group/vim_dev/msg/302b0c87138dea0d
    http://ftp.vim.org/pub/vim/unstable/patches/7.2b/7.2b.014

[2] Thanks to Robert Buchholz for pointing this out in:
    Message-Id: &lt;200807250317.30880.rbu@gentoo.org&gt;
    http://lists.grok.org.uk/pipermail/full-disclosure/2008-July/063444.html



6. COPYRIGHT

This advisory is Copyright 2008 Jan Minar &lt;rdancer@rdancer.org&gt;

Copying welcome, under the Creative Commons ``Attribution-Share Alike''
License http://creativecommons.org/licenses/by-sa/2.0/uk/

Code included herein, and accompanying this advisory, may be copied
according to the GNU General Public License version 2, or the Vim
license.  See the subdirectory ``licenses''.

Various portions of the accompanying code were written by various
parties.  Those parties may hold copyright, and those portions may be
copied according to their respective licenses.


7. HISTORY

2008-07-26 Update: There is no race condition
2008-07-24 Added info on Patch 7.2b.014 (fixes the vulnerability)
2008-07-18 Formatting changes
2008-07-17 Sent to: &lt;bugs@vim.org&gt;, &lt;vim-dev@vim.org&gt; 
	   &lt;full-disclosure@lists.grok.org.uk&gt;,
	   &lt;bugtraq@securityfocus.com&gt;
</pre>
<p></p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
