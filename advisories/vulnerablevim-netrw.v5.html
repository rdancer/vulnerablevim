<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
<title>
Arbitrary code execution in Netrw version 127, Vim 7.2b
</title>
    <link rel="stylesheet" href="../stylesheets/styles.css">
    <link rel="stylesheet" href="../stylesheets/github-light.css">
    <link rel="stylesheet" type="text/css" href="vulnerablevim.css">
    <script src="../javascripts/scale.fix.js"></script>
    <script type="text/javascript" src="vulnerablevim.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Vulnerable Vim</h1>
        <p class="header">The Vim Text Editor Security Advisories</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/rdancer/vulnerablevim/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/rdancer/vulnerablevim/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/rdancer/vulnerablevim">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/rdancer">rdancer</a></p>


      </header>
      <section>
<pre>
<span class="vulntitle"
>Arbitrary code execution in Netrw version 127, Vim 7.2b</span>

1. Summary

Product  : Vim -- Vi IMproved, Netrw
Version  : Tested with Vim 7.2b, Netrw 127
Impact   : Arbitrary code execution
Wherefrom: Local, possibly remote
Original : http://www.rdancer.org/vulnerablevim-netrw.v5.html
	   http://www.rdancer.org/vulnerablevim-latest.tar.bz2

Lack of sanitization throughout Netrw can lead to arbitrary code execution upon
opening a directory with a crafted name.


2. Overview

``Netrw makes reading, writing, and browsing over a network connection
easy!  [...] Netrw supports &quot;transparent&quot; editing of files on other
machines using urls [...]''

	-- Netrw Reference Manual (pi_netrw.txt)

For the new Vim version, the Netrw plugin has been updated with the new
fnameescape() and shellescape() functions.  However, not all of the
vulnerable statements have been sanitized, and Netrw is still vulnerable
to arbitrary code execution.

The latest version of the archive with code that we're using can be
found at: ``http://www.rdancer.org/vulnerablevim-latest.tar.bz2''.


Best results are achieved by running ``make test'' in the root directory
of the abovementioned archive (this advisory details the ``netrw.v5''
test case):

        -------------------------------------------
        -------- Test results below ---------------
        -------------------------------------------
        Vim version 7.2b
        zip.vim version: v21
        netrw.vim version: v127
        -------------------------------------------
        filetype.vim
          strong  : EXPLOIT FAILED
          weak    : EXPLOIT FAILED
        tarplugin : EXPLOIT FAILED
        tarplugin.updated: EXPLOIT FAILED
        zipplugin : EXPLOIT FAILED
        zipplugin.v2: EXPLOIT FAILED
        xpm.vim
          xpm     : EXPLOIT FAILED
          xpm2    : EXPLOIT FAILED
          remote  : EXPLOIT FAILED
        gzip_vim  : EXPLOIT FAILED
        netrw     : EXPLOIT FAILED
        netrw.v2  : EXPLOIT FAILED
        netrw.v3  : VULNERABLE
        netrw.v4  : EXPLOIT FAILED
    --&gt; netrw.v5  : VULNERABLE


3. Vulnerability

Few unsanitized statements still remain in ``netrw.vim'':

	$ grep -n exe ~/.vim/autoload/netrw.vim|grep -v -e escape -e Decho -e executable | wc -l
	239

We will exploit the part of code where upon opening a directory, a
string of keyboard mappings is loaded, using the ``execute'' command,
with no sanitization of the ``b:netrw_curdir'' variable, which holds the
current directory name.  In function s:BrowserMaps():

        1709    if s:didstarstar || !mapcheck(&quot;&lt;s-up&gt;&quot;,&quot;n&quot;)
        1710     nnoremap &lt;buffer&gt; &lt;silent&gt; &lt;s-up&gt;   :Pexplore&lt;cr&gt;
        1711    endif
        1712    if g:netrw_mousemaps == 1
        1713     nnoremap &lt;buffer&gt; &lt;silent&gt; &lt;leftmouse&gt;   &lt;leftmouse&gt;:call &lt;SID&gt;NetrwLeftmouse(1)&lt;cr&gt;
        1714     nnoremap &lt;buffer&gt; &lt;silent&gt; &lt;middlemouse&gt; &lt;leftmouse&gt;:call &lt;SID&gt;NetrwPrevWinOpen(1)&lt;cr&gt;
        1715     nnoremap &lt;buffer&gt; &lt;silent&gt; &lt;s-leftmouse&gt; &lt;leftmouse&gt;:call &lt;SID&gt;NetrwMarkFile(1,&lt;SID&gt;NetrwGetWord())&lt;cr&gt;
   --&gt;  1716     exe 'nnoremap &lt;buffer&gt; &lt;silent&gt; &lt;rightmouse&gt;  &lt;leftmouse&gt;:call &lt;SID&gt;NetrwLocalRm(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
   --&gt;  1717     exe 'vnoremap &lt;buffer&gt; &lt;silent&gt; &lt;rightmouse&gt;  &lt;leftmouse&gt;:call &lt;SID&gt;NetrwLocalRm(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
        1718    endif
   --&gt;  1719    exe 'nnoremap &lt;buffer&gt; &lt;silent&gt; &lt;del&gt;        :call &lt;SID&gt;NetrwLocalRm(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
   --&gt;  1720    exe 'vnoremap &lt;buffer&gt; &lt;silent&gt; &lt;del&gt;        :call &lt;SID&gt;NetrwLocalRm(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
   --&gt;  1721    exe 'nnoremap &lt;buffer&gt; &lt;silent&gt; D            :call &lt;SID&gt;NetrwLocalRm(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
   --&gt;  1722    exe 'vnoremap &lt;buffer&gt; &lt;silent&gt; D            :call &lt;SID&gt;NetrwLocalRm(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
   --&gt;  1723    exe 'nnoremap &lt;buffer&gt; &lt;silent&gt; R            :call &lt;SID&gt;NetrwLocalRename(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
   --&gt;  1724    exe 'vnoremap &lt;buffer&gt; &lt;silent&gt; R            :call &lt;SID&gt;NetrwLocalRename(&quot;'.b:netrw_curdir.'&quot;)&lt;cr&gt;'
   --&gt;  1725    exe 'nnoremap &lt;buffer&gt; &lt;silent&gt; &lt;Leader&gt;m    :call &lt;SID&gt;NetrwMakeDir(&quot;&quot;)&lt;cr&gt;'
        1726    nnoremap &lt;buffer&gt; &lt;F1&gt;               :he netrw-quickhelp&lt;cr&gt;


4. Exploit
	
Run ``make test''.  See ``netrw.v5/Makefile'' for details.  If Vim is
vulnerable, number of times the payload has been run is printed.
Current version of Vim will run the payload six times.


5. Mitigation

Do not use Vim to open untrusted directories or files whose path
contains untrusted directories.


6. Copyright

This advisory is Copyright 2008 Jan Minar &lt;rdancer@rdancer.org&gt;

Copying welcome, under the Creative Commons ``Attribution-Share Alike''
License http://creativecommons.org/licenses/by-sa/2.0/uk/

Code included herein, and accompanying this advisory, may be copied
according to the GNU General Public License version 2, or the Vim
license.  See the subdirectory ``licenses''.

Various portions of the accompanying code were written by various
parties.  Those parties may hold copyright, and those portions may be
copied according to the respective licenses.


7. History

2008-07-16 Sent to: &lt;vim-dev@vim.org&gt; -- This is the correct address, not
           &lt;vim-dev@googlegroups.com&gt;
2008-07-16 Sent to: &lt;bugs@vim.org&gt;, &lt;vim-dev@googlegroups.com&gt;,
	   &lt;full-disclosure@lists.grok.org.uk&gt;, &lt;bugtraq@securityfocus.com&gt;
</pre>
<p></p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
