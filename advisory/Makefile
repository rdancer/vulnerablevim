# Makefile to create HTMLized version of advisories

DOCTYPE = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">'
COMMENT = '<!-- Automatically generated by advisory/Makefile -->'
ORDER = vulnerablevim-filetype.vim.updated.in vulnerablevim-configure.in.in vulnerablevim-shellescape.in vulnerablevim-netrw.v5.in vulnerablevim-netrw.v2.in vulnerablevim.in 

# vulnerablevim-filetype.vim.updated.in	XXXX-XX-XX
# vulnerablevim-configure.in.in		2008-07-17
# vulnerablevim-shellescape.in		2008-07-16
# vulnerablevim-netrw.v5.in		2008-07-16
# vulnerablevim-netrw.v2.in		2008-07-03
# vulnerablevim.in			2008-06-13

.PHONY: all
all: vulnerablevim-index.html
	for input in ./*.in; do \
	  output="`printf '%s\n' "$$input" | sed 's/\.in$$/.html/'`"; \
	  printf '%s\n' \
	    $(DOCTYPE) \
	    $(COMMENT) \
	    '<html>' \
	      '<head>' \
		'<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >' \
		'<title>' \
		   "$$( head -n1 < "$$input" | recode ..html )" \
		'</title>' \
	      '</head>' \
	      '<body>' \
		'<pre>'\
		  "$$( sed -n '/^1/,$$p' < "$$input" | recode ..html )" \
		'</pre>' \
	      '</body>' \
	    '</html>' \
	      > "$$output"; \
	  done

.PHONY: clean
clean:
	rm -f -- ./*.html

# Needs to be .PHONY, as it's made out of all the files
.PHONY: vulnerablevim-index.html
vulnerablevim-index.html:
	# The sed(1) bellow blindly converts all URLs, even the one in
	# the doctype
	printf '%s\n%s\n' $(DOCTYPE) $(COMMENT) > vulnerablevim-index.html
	printf '%s\n' \
	  '<html>' \
	    '<head>' \
	      '<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >' \
	      '<title>' \
		 'Vim Security Advisories'\
	      '</title>' \
	    '</head>' \
	    '<body>' \
		"`./makeindex $(ORDER)`" \
	    '</body>' \
	  '</html>' \
	| sed 's#\<http://[-[:alnum:]:%?_.~!#&+=/]*#<a href="&">&</a>#g' \
	    >> vulnerablevim-index.html

# test_order -- Bail out in case there are unrecognized input files
.PHONY: test_order
test_order:
	for a in *.in; do \
	  case " $(ORDER) " in \
	    *" $$a "*);; \
	    *) \
	      echo "Unrecognized input file: $$a" >&2; \
	      exit 1; \
	      ;; \
	  esac; \
	done


# vim: sw=2 :
