<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- Automatically generated by advisory/Makefile -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>
Arbitrary code execution in Netrw, fully patched Vim 7.2a
</title>
</head>
<body>
<pre>
1. Summary

Product  : Vim -- Vi IMproved
Version  : Tested with 7.2a.10
Impact   : Arbitrary code execution
Wherefrom: Local, possibly remote
Original : http://www.rdancer.org/vulnerablevim-netrw.v2.html

Lack of sanitization can lead to arbitrary code execution.


2. Overview

``Vim is an almost compatible version of the UNIX editor Vi.  Many new features
have been added: multi-level undo, syntax highlighting, command line history,
on-line help, spell checking, filename completion, block operations, etc.''
	-- VIM 7.1 README.txt

``Netrw makes reading, writing, and browsing over a network connection easy!
[...] Netrw supports &quot;transparent&quot; editing of files on other machines using
urls [...]''

	-- Netrw Reference Manual (pi_netrw.txt)

The archive with code that is a part of this advisory can be found at
``http://www.rdancer.org/vulnerablevim-netrw.v2.tar.bz2''.


3. Details

3.0. Vim Version and Netrw Version

In this advisory, we analyse Vim version 7.2a.10, Netrw version	125.


3.1. Prerequisite: Marking Files (The ``mf'' Command)

``One may mark files with the cursor atop a filename and then pressing &quot;mf&quot;.
With gvim, one may also mark files with &lt;s-leftmouse&gt;.''

	-- Netrw Reference Manual (pi_netrw.txt)


3.2. Compression and Decompression (The ``mz'' Command)

``If any marked files are compressed,   then &quot;mz&quot; will decompress them.
If any marked files are decompressed, then &quot;mz&quot; will compress them
using the command specified by |g:netrw_compress|; by default,
that's &quot;gzip&quot;.''

	-- Netrw Reference Manual (pi_netrw.txt)

Invoking the ``mz'' command upon a file with a crafted file name can lead to
arbitrary code execution.


3.2.1 Vulnerability

In many places, Netrw ($VIMRUNTIME/autoload/netrw.vim) fails to sanitize file
names used as shell arguments.

In function s:NetrwMarkFileExe() (The ``mx'' command): ``apply command to marked
files.  Substitute: filename -&gt; % If no %, then append a space and the filename
to the command'':

        4036    for fname in s:netrwmarkfilelist_{curbufnr}
        4037     if a:islocal
        4038      if g:netrw_keepdir
        4039       let fname= s:ComposePath(curdir,fname)
        4040      endif
        4041     else
        4042      let fname= b:netrw_curdir.fname
        4043     endif
        4044     if cmd =~ '%'
        4045      let xcmd= substitute(cmd,'%',fname,'g')
        4046     else
        4047      let xcmd= cmd.' '.fname
        4048     endif
        4049     if a:islocal
        4050 &quot;     call Decho(&quot;local: xcmd&lt;&quot;.xcmd.&quot;&gt;&quot;)
    --&gt; 4051      let ret= system(xcmd)
        4052     else
        4053 &quot;     call Decho(&quot;remote: xcmd&lt;&quot;.xcmd.&quot;&gt;&quot;)
    --&gt; 4054      let ret= s:RemoteSystem(xcmd)

Following code in function s:NetrwMarkFileCompress() is run when the ``mz''
(compress/decompress) command is invoked.  The variable
``s:netrwmarkfilelist_{curbufnr}'' holds the marked files list.:

	 159 if !exists(&quot;g:netrw_decompress&quot;)
	 160  let g:netrw_decompress= { &quot;.gz&quot; : &quot;gunzip&quot; , &quot;.bz2&quot; : &quot;bunzip2&quot; , &quot;.zip&quot; : &quot;unzip&quot; , &quot;.tar&quot; : &quot;tar -xf&quot;}
	 161 endif
	[...]
        3816    for fname in s:netrwmarkfilelist_{curbufnr}
        3817     &quot; for every filename in the marked list
        3818     for sfx in sort(keys(g:netrw_decompress))
        3819      if fname =~ '\'.sfx.'$'
        3820       &quot; fname has a suffix indicating that its compressed; apply associated decompression routine
        3821       let exe= g:netrw_decompress[sfx]
        3822 &quot;      call Decho(&quot;fname&lt;&quot;.fname.&quot;&gt; is compressed so decompress with &lt;&quot;.exe.&quot;&gt;&quot;)
        3823       if a:islocal
        3824        if g:netrw_keepdir
        3825         let fname= s:ComposePath(curdir,fname)
        3826        endif
        3827       else
        3828        let fname= b:netrw_curdir.fname
        3829       endif
        3830       if executable(exe)
        3831        if a:islocal
    --&gt; 3832         call system(exe.&quot; &quot;.fname)


3.2.2. Exploit

We exploit the statement on line 3832.

Run ``make demo'' or ``make test'' in the netrw.v2 directory.

For details on the exploit construction, see netrw.v2/Makefile.

Note: ``make test'' may hang when run from within vim.


3.2.3. Remedy

The shellescape() function[1] should be used to sanitize ``fname''.


3.3. Copying Files (The ``mc'' Command)

``[Copying:]  Select a target directory with mt (|netrw-mt|).  Then change
directory, select file(s) (see |netw-mf|), and press &quot;mc&quot;.''

	-- Netrw Reference Manual (pi_netrw.txt)

Invoking the ``mc'' command inside a directory with a crafted directory name
can lead to arbitrary code execution.


3.3.1. Vulnerability

Netrw inappropriately uses shellescape() in many places to sanitize arguments of the
``execute'' command.

        708   exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_rcp_cmd.&quot; &quot;.s:netrw_rcpmode.&quot; &quot;.shellescape(uid_machine.&quot;:&quot;.escape(b:netrw_fname,' ?&amp;;').&quot; &quot;.tmpfile)
        810    exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_scp_cmd.useport.&quot; &quot;.shellescape(g:netrw_machine.&quot;:&quot;.escape(b:netrw_fname,g:netrw_fname_escape)).&quot; &quot;.tmpfile
        831     exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_http_cmd.&quot; &quot;.shellescape(tmpfile).&quot; &quot;.shellescape(&quot;http://&quot;.g:netrw_machine.netrw_fname)
        842     exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_http_cmd.&quot; &quot;.shellescape(tmpfile).&quot; &quot;.shellescape(&quot;http://&quot;.g:netrw_machine.netrw_html)
        882    exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_rsync_cmd.&quot; &quot;.shellescape(g:netrw_machine.&quot;:&quot;.netrw_fname).&quot; &quot;.tmpfile
        907     exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_fetch_cmd.&quot; &quot;.tmpfile.&quot; &quot;.shellescape(netrw_option.&quot;://&quot;.g:netrw_uid.':'.s:netrw_passwd.'@'.g:netrw_machine.&quot;/&quot;.netrw_fname)
        910     exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_fetch_cmd.&quot; &quot;.tmpfile.&quot; &quot;.shellescape(netrw_option.&quot;://&quot;.g:netrw_machine.&quot;/&quot;.netrw_fname)
        923    exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_sftp_cmd.&quot; &quot;.shellescape(g:netrw_machine.&quot;:&quot;.netrw_fname).&quot; &quot;.tmpfile
        1084    exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_rcp_cmd.&quot; &quot;.s:netrw_rcpmode.&quot; &quot;.shellescape(tmpfile).&quot; &quot;.shellescape(uid_machine.&quot;:&quot;.netrw_fname)
        1177    exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_scp_cmd.useport.&quot; &quot;.shellescape(tmpfile).&quot; &quot;.shellescape(g:netrw_machine.&quot;:&quot;.netrw_fname)
        2976   exe &quot;silent !&quot;.viewer.&quot; &quot;.viewopt.shellescape(fname).redir
        2981   exe 'silent !start rundll32 url.dll,FileProtocolHandler '.shellescape(fname)
        2987   exe &quot;silent !gnome-open &quot;.shellescape(fname).redir
        2992   exe &quot;silent !kfmclient exec &quot;.shellescape(fname).&quot; &quot;.redir
        2997   exe &quot;silent !open &quot;.shellescape(fname).&quot; &quot;.redir
        3656    exe &quot;silent! !&quot;.g:netrw_local_mkdir.' '.shellescape(newdirname)
        3680   exe &quot;silent! !&quot;.mkdircmd.&quot; &quot;.shellescape(newdirname)
        3911    exe &quot;silent! !&quot;.g:netrw_local_mkdir.' '.shellescape(tmpdir)
        4775    exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_scp_cmd.useport.&quot; &quot;.filelist.&quot; &quot;.shellescape(tgtdir)
        5058    exe s:netrw_silentxfer.&quot;!&quot;.g:netrw_scp_cmd.useport.&quot; &quot;.args.&quot; &quot;.shellescape(machine.&quot;:&quot;.escape(tgt,g:netrw_fname_escape))
        6001    exe &quot;silent r! &quot;.listcmd.shellescape(s:path)
        6015     exe &quot;silent r! &quot;.listcmd.' &quot;'.shellescape(s:path).'&quot;'


        3888    let args= join(map(copy(s:netrwmarkfilelist_{bufnr('%')}),&quot;b:netrw_curdir.\&quot;/\&quot;.shellescape(v:val)&quot;))
        3889 &quot;   call Decho(&quot;system(&quot;.g:netrw_localcopycmd.&quot; &quot;.args.&quot; &quot;.shellescape(s:netrwmftgt).&quot;)&quot;)
    --&gt; 3890    call system(g:netrw_localcopycmd.&quot; &quot;.args.&quot; &quot;.shellescape(s:netrwmftgt))

3.3.2. Exploit

Run ``make demo'' or ``make test'' in the netrw.v3 directory.  Note: ``make
test'' may hang when run from within vim.


3.3.3. Remedy

The shellescape() function[1] should be used to sanitize ``b:netrw_curdir'' --
following patch may be applied:

--- /usr/local/share/vim/vim72a/autoload/netrw.vim      2008-07-01 18:38:09.000000000 +0100
+++ -   2008-07-03 19:01:50.676582822 +0100
@@ -3885,7 +3885,7 @@
   if      a:islocal &amp;&amp;  s:netrwmftgt_islocal
       &quot; Copy marked files, local directory to local directory
        &quot;   call Decho(&quot;copy from local to local&quot;)
        -   let args= join(map(copy(s:netrwmarkfilelist_{bufnr('%')}),&quot;b:netrw_curdir.\&quot;/\&quot;.shellescape(v:val)&quot;))
        +   let args= join(map(copy(s:netrwmarkfilelist_{bufnr('%')}),&quot;shellescape(b:netrw_curdir).\&quot;/\&quot;.shellescape(v:val)&quot;))
         &quot;   call Decho(&quot;system(&quot;.g:netrw_localcopycmd.&quot; &quot;.args.&quot; &quot;.shellescape(s:netrwmftgt).&quot;)&quot;)
             call system(g:netrw_localcopycmd.&quot; &quot;.args.&quot; &quot;.shellescape(s:netrwmftgt))



3.4. Deleting Files (The ``D'' Command)

``Deleting/removing files and directories involves moving the cursor to the
file/directory to be deleted and pressing &quot;D&quot;.''

	-- Netrw Reference Manual (pi_netrw.txt)

Applying the ``D'' to a file with a crafted file name, or inside a directory
with a crafted directory name, can lead to arbitrary code execution.


3.4.1 Vulnerability

Netrw fails to properly sanitize arguments passed to the s:System() function,
which is a wrapper for the ``execute'' command:

        7596    fun! s:System(cmd,path)
        [...]
        7599      let path = a:path
        [...]
        7615        exe &quot;let result= &quot;.a:cmd.&quot;('&quot;.path.&quot;')&quot;

In  function s:NetrwLocalRmFile():

        6724	fun! s:NetrwLocalRmFile(path,fname,all)
        [...]
        6730	  let rmfile= s:ComposePath(a:path,a:fname)
        [...]
    --&gt; 6754	    let ret= s:System(&quot;delete&quot;,rmfile)
        [...]
    --&gt; 6777	    call s:System(&quot;system&quot;,g:netrw_local_rmdir.' '.shellescape(rmfile))
        [...]
    --&gt; 6782	     let errcode= s:System(&quot;delete&quot;,rmfile)
        [...]
    --&gt; 6788	       call s:System(&quot;system&quot;,&quot;rm &quot;.shellescape(rmfile))

In function s:NetrwLocalRmFile():
        6730   let rmfile= s:ComposePath(a:path,a:fname)
        [...]
    --&gt; 6754     let ret= s:System(&quot;delete&quot;,rmfile)
        [...]
    --&gt; 6777     call s:System(&quot;system&quot;,g:netrw_local_rmdir.' '.shellescape(rmfile))
        6778 &quot;    call Decho(&quot;v:shell_error=&quot;.v:shell_error)
        6779
        6780     if v:shell_error != 0
        6781 &quot;     call Decho(&quot;2nd attempt to remove directory&lt;&quot;.rmfile.&quot;&gt;&quot;)
    --&gt; 6782      let errcode= s:System(&quot;delete&quot;,rmfile)
        6783 &quot;     call Decho(&quot;errcode=&quot;.errcode)
        6784
        6785      if errcode != 0
        6786       if has(&quot;unix&quot;)
        6787 &quot;       call Decho(&quot;3rd attempt to remove directory&lt;&quot;.rmfile.&quot;&gt;&quot;)
    --&gt; 6788        call s:System(&quot;system&quot;,&quot;rm &quot;.shellescape(rmfile))


3.4.2 Exploit

We exploit the statement on the line 6754.  Run ``make demo'' or ``make test''
in the netrw.v4 directory.  Note: ``make test'' may hang when run from within
vim.  We use the TIOCSTY ioctl to simulate keyboard input in ``make test'' --
may not work everywhere.


4. Footnotes

[1] shellescape() was introduced in patch 7.0.111.


5. Copyright

This advisory is Copyright 2008 Jan Minar &lt;rdancer@rdancer.org&gt;

Copying welcome, under the Creative Commons ``Attribution-Share Alike'' License
http://creativecommons.org/licenses/by-sa/2.0/uk/

Code included herein, and accompanying this advisory, may be copied according to
the GNU General Public License version 2, or the Vim license.  See the
subdirectory ``licenses''.

Various portions of the accompanying code were written by various parties.
Those parties may hold copyright, and those portions may be copied according
to the respective licenses.


6. History

2008-07-16 Note: The correct address is &lt;vim-dev@vim.org&gt; NOT
	   &lt;vim_dev@googlegroups.com&gt;
2008-07-03 Sent to: &lt;full-disclosure@lists.grok.org.uk&gt;,
	   &lt;bugtraq@securityfocus.com&gt;, &lt;vim_dev@googlegroups.com&gt;
	   Copy to: &lt;bugs@vim.org&gt;
</pre>
</body>
</html>
